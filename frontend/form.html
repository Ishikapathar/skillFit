<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .autocomplete-suggestions {
      border: 1px solid #ddd;
      background: white;
      max-height: 150px;
      overflow-y: auto;
      border-radius: 8px;
      margin-top: 4px;
      position: absolute;
      width: 100%;
      z-index: 50;
    }
    .autocomplete-suggestion {
      padding: 8px;
      cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background: #f3f4f6;
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen">

  <div class="bg-white shadow-2xl rounded-2xl p-10 w-full max-w-xl transform transition hover:scale-105 duration-300">
    <h1 class="text-3xl font-bold text-center text-purple-600 mb-6 animate-pulse">
      Internship Recommendation Form
    </h1>

    <form id="studentForm" class="space-y-5 relative">
      
      <!-- Name -->
      <div>
        <label class="block text-gray-700 font-medium">Name</label>
        <input type="text" id="name" required
               class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
      </div>

      <!-- Current Study / Course (CS only) -->
      <div>
        <label class="block text-gray-700 font-medium">Current Study / Course</label>
        <select id="course"
                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
          <option value="">Select Course</option>
          <option value="btech_cs">B.Tech Computer Science</option>
          <option value="mtech_cs">M.Tech Computer Science</option>
          <option value="bsc_cs">B.Sc Computer Science</option>
          <option value="msc_cs">M.Sc Computer Science</option>
          <option value="bca">BCA</option>
          <option value="mca">MCA</option>
          <option value="diploma_cs">Diploma in Computer Science</option>
        </select>
      </div>

      <!-- Skills -->
      <div class="relative">
        <label class="block text-gray-700 font-medium">Skills</label>
        <div id="skills-container"
             class="flex flex-wrap items-center border rounded-lg p-2 cursor-text min-h-[48px]"
             onclick="document.getElementById('skills-input').focus()">
          <input type="text" id="skills-input" placeholder="Type a skill and press Enter"
                 class="flex-1 outline-none p-2">
        </div>
        <div id="skills-suggestions" class="autocomplete-suggestions hidden"></div>
      </div>

      <!-- Location -->
      <div class="relative">
        <label class="block text-gray-700 font-medium">Preferred Locations</label>
        <div id="location-container"
             class="flex flex-wrap items-center border rounded-lg p-2 cursor-text min-h-[48px]"
             onclick="document.getElementById('location-input').focus()">
          <input type="text" id="location-input" placeholder="Type a location and press Enter"
                 class="flex-1 outline-none p-2">
        </div>
        <div id="location-suggestions" class="autocomplete-suggestions hidden"></div>
      </div>

      <!-- Preferred Field -->
      <div>
        <label class="block text-gray-700 font-medium">Preferred Field</label>
        <select id="field"
                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
        </select>
      </div>

      <!-- Resume Upload Section -->
      <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border-2 border-dashed border-purple-300">
        <label class="block text-gray-700 font-medium mb-2">Upload Resume (Optional)</label>
        <p class="text-sm text-gray-600 mb-3">Upload your resume to get a personalized dashboard with AI-powered insights based on your projects and experience.</p>
        
        <div class="flex items-center justify-center w-full">
          <label for="resume-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-purple-300 border-dashed rounded-lg cursor-pointer bg-purple-50 hover:bg-purple-100 transition">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <svg class="w-8 h-8 mb-4 text-purple-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
              </svg>
              <p class="mb-2 text-sm text-purple-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
              <p class="text-xs text-purple-400">PDF, DOC, DOCX (MAX. 5MB)</p>
            </div>
            <input id="resume-upload" type="file" class="hidden" accept=".pdf,.doc,.docx" />
          </label>
        </div>
        <div id="resume-status" class="mt-2 text-sm"></div>
      </div>

      <div class="flex gap-3">
        <button type="submit"
                class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 px-4 rounded-lg hover:opacity-90 transition duration-300 font-bold">
          Get Recommendations
        </button>
        
        <button type="button" id="dashboard-btn"
                class="px-6 py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-lg hover:opacity-90 transition duration-300 font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
          My Dashboard
        </button>
      </div>
    </form>
  </div>

  <script>
    // --- Data for skills, locations, fields ---
    const skillsList = ["Python", "SQL", "Machine Learning", "Deep Learning", "HTML", "CSS", "React", "Django", "Java", "C++", "JavaScript", "Node.js"];
    const locationList = ["Ahmedabad, Gujarat, India", "Bangalore, Karnataka, India", "Bhubaneswar", "Chennai, Tamil Nadu, India", "Coimbatore", "Delhi", "Gurgaon, Haryana, India", "Hyderabad, Telangana, India", "Hyderabad", "India", "Jaipur", "Kolkata", "Mumbai, Maharashtra, India", "Mumbai", "Mysore", "Nagpur", "New Delhi, India", "Noida, Uttar Pradesh, India", "Noida", "Pan India", "Pune, Maharashtra, India", "Pune", "Trivandrum", "Udupi", "Varanasi"];
    const fieldsList = ["AI/ML", "Data Science", "Web Development", "Mobile Development", "Cybersecurity", "Cloud Computing", "UI/UX", "DevOps", "Blockchain", "IoT"];

    // --- Fill field select ---
    const fieldSelect = document.getElementById("field");
    fieldsList.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f;
      opt.textContent = f;
      fieldSelect.appendChild(opt);
    });

    // --- Multi-skill system ---
    let selectedSkills = [];
    const skillsContainer = document.getElementById("skills-container");
    const skillsInput = document.getElementById("skills-input");
    const skillsBox = document.getElementById("skills-suggestions");

    function renderSkills() {
      skillsContainer.querySelectorAll(".skill-tag").forEach(tag => tag.remove());
      selectedSkills.forEach(skill => {
        const tag = document.createElement("span");
        tag.textContent = skill;
        tag.className = "skill-tag bg-purple-200 text-purple-800 px-2 py-1 m-1 rounded-lg text-sm font-medium flex items-center";
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "√ó";
        removeBtn.className = "ml-2 text-red-500 font-bold";
        removeBtn.onclick = () => {
          selectedSkills = selectedSkills.filter(s => s !== skill);
          renderSkills();
        };
        tag.appendChild(removeBtn);
        skillsContainer.insertBefore(tag, skillsInput);
      });
    }

    skillsInput.addEventListener("input", () => {
      const query = skillsInput.value.toLowerCase();
      skillsBox.innerHTML = "";
      if (!query) { skillsBox.classList.add("hidden"); return; }
      const matches = skillsList.filter(item => item.toLowerCase().includes(query) && !selectedSkills.includes(item));
      matches.forEach(match => {
        const div = document.createElement("div");
        div.classList.add("autocomplete-suggestion");
        div.textContent = match;
        div.onclick = () => {
          selectedSkills.push(match);
          skillsInput.value = "";
          skillsBox.classList.add("hidden");
          renderSkills();
        };
        skillsBox.appendChild(div);
      });
      skillsBox.classList.remove("hidden");
    });

    skillsInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && skillsInput.value.trim()) {
        e.preventDefault();
        const newSkill = skillsInput.value.trim();
        if (!selectedSkills.includes(newSkill)) selectedSkills.push(newSkill);
        skillsInput.value = "";
        skillsBox.classList.add("hidden");
        renderSkills();
      }
    });

    // --- Multi-location system ---
    let selectedLocations = [];
    const locationContainer = document.getElementById("location-container");
    const locationInput = document.getElementById("location-input");
    const locationBox = document.getElementById("location-suggestions");

    function renderLocations() {
      locationContainer.querySelectorAll(".location-tag").forEach(tag => tag.remove());
      selectedLocations.forEach(loc => {
        const tag = document.createElement("span");
        tag.textContent = loc;
        tag.className = "location-tag bg-indigo-200 text-indigo-800 px-2 py-1 m-1 rounded-lg text-sm font-medium flex items-center";
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "√ó";
        removeBtn.className = "ml-2 text-red-500 font-bold";
        removeBtn.onclick = () => {
          selectedLocations = selectedLocations.filter(l => l !== loc);
          renderLocations();
        };
        tag.appendChild(removeBtn);
        locationContainer.insertBefore(tag, locationInput);
      });
    }

    locationInput.addEventListener("input", () => {
      const query = locationInput.value.toLowerCase();
      locationBox.innerHTML = "";
      if (!query) { locationBox.classList.add("hidden"); return; }
      const matches = locationList.filter(item => item.toLowerCase().includes(query) && !selectedLocations.includes(item));
      matches.forEach(match => {
        const div = document.createElement("div");
        div.classList.add("autocomplete-suggestion");
        div.textContent = match;
        div.onclick = () => {
          selectedLocations.push(match);
          locationInput.value = "";
          locationBox.classList.add("hidden");
          renderLocations();
        };
        locationBox.appendChild(div);
      });
      locationBox.classList.remove("hidden");
    });

    locationInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && locationInput.value.trim()) {
        e.preventDefault();
        const newLoc = locationInput.value.trim();
        if (!selectedLocations.includes(newLoc)) selectedLocations.push(newLoc);
        locationInput.value = "";
        locationBox.classList.add("hidden");
        renderLocations();
      }
    });

    // --- Resume Upload Handler ---
    let uploadedResume = null;
    const resumeUpload = document.getElementById("resume-upload");
    const resumeStatus = document.getElementById("resume-status");
    const dashboardBtn = document.getElementById("dashboard-btn");

    resumeUpload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file
      const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      const maxSize = 5 * 1024 * 1024; // 5MB

      if (!validTypes.includes(file.type)) {
        resumeStatus.innerHTML = '<span class="text-red-500">‚ùå Invalid file type. Please upload PDF, DOC, or DOCX.</span>';
        return;
      }

      if (file.size > maxSize) {
        resumeStatus.innerHTML = '<span class="text-red-500">‚ùå File too large. Maximum size is 5MB.</span>';
        return;
      }

      resumeStatus.innerHTML = '<span class="text-blue-500">üìÑ Processing resume...</span>';

      try {
        // Convert file to base64 for storage
        const base64 = await fileToBase64(file);
        uploadedResume = {
          name: file.name,
          type: file.type,
          size: file.size,
          data: base64,
          uploadDate: new Date().toISOString()
        };

        // Store resume data
        const studentEmail = localStorage.getItem("studentEmail");
        let resumeData = JSON.parse(localStorage.getItem("resumeData") || "{}");
        resumeData[studentEmail] = uploadedResume;
        localStorage.setItem("resumeData", JSON.stringify(resumeData));

        resumeStatus.innerHTML = '<span class="text-green-500">‚úÖ Resume uploaded successfully!</span>';
        dashboardBtn.disabled = false;
        dashboardBtn.classList.remove("opacity-50", "cursor-not-allowed");
      } catch (error) {
        resumeStatus.innerHTML = '<span class="text-red-500">‚ùå Error processing resume. Please try again.</span>';
      }
    });

    // Dashboard button handler
    dashboardBtn.addEventListener("click", () => {
      if (uploadedResume) {
        window.location.href = "./dashboard.html";
      }
    });

    // Helper function to convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Check if user already has a resume uploaded
    window.addEventListener("load", () => {
      const studentEmail = localStorage.getItem("studentEmail");
      const resumeData = JSON.parse(localStorage.getItem("resumeData") || "{}");
      if (resumeData[studentEmail]) {
        uploadedResume = resumeData[studentEmail];
        resumeStatus.innerHTML = '<span class="text-green-500">‚úÖ Resume already uploaded: ' + uploadedResume.name + '</span>';
        dashboardBtn.disabled = false;
        dashboardBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    });

    // --- Submit handler ---
    const form = document.getElementById("studentForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const studentData = {
        name: document.getElementById("name").value,
        course: document.getElementById("course").value,
        skills: selectedSkills,
        locations: selectedLocations,
        field: document.getElementById("field").value,
        top_n: 5
      };

      // If resume is uploaded, send it to backend for processing
      if (uploadedResume) {
        try {
          const response = await fetch('http://127.0.0.1:8000/upload_resume', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              student_email: localStorage.getItem("studentEmail"),
              resume_data: uploadedResume.data,
              filename: uploadedResume.name,
              file_type: uploadedResume.type
            })
          });
          
          const result = await response.json();
          if (result.success) {
            console.log('Resume processed successfully:', result.analysis_preview);
          }
        } catch (error) {
          console.error('Error uploading resume:', error);
        }
      }

      localStorage.setItem("studentData", JSON.stringify(studentData));
      window.location.href = "./results.html";
    });
  </script>
</body>
</html>